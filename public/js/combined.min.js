function load3D(x,m,d){var t={data:x.coords,verticalScale:d};var b=Math.max(x.width,x.height);var c,i;var u,v,p,a,s,h;var r=Math.PI/4;var j=0;var f=0;var g=0;var q=Math.PI/8;var o=0;var e=0;var n=0;var w=35;var l=0;var k=0;slicesObjs=[];t.setVerticalScale=function(z){t.verticalScale=z;for(var y=0;y<slicesObjs.length;y++){h.remove(slicesObjs[y])}slicesObjs.length=0;t.renderSlices()};t.setRotation=function(z,y){y=defaultParam(y,q);r=z;q=y};t.addShape=function(H,L,K,I,C,B,A){var E=300;var D={amount:0.2/E,steps:1,bevelSegments:1,bevelSize:0.2/E,bevelThickness:0.2/E};var F=16777215;var G=new THREE.MeshLambertMaterial({color:F});var J=new THREE.ExtrudeGeometry(H,D);var M=new THREE.Mesh(J,G);M.scale.set(E,E,E);M.position.set(L*E,K*E,I*E);M.rotation.set(C,B,A);M.castShadow=true;M.receiveShadow=true;h.add(M);slicesObjs.push(M)};t.renderSlices=function(){var D,z;for(var C=0;C<t.data.h.length;C++){D=[new THREE.Vector2(x.width/b,0),new THREE.Vector2(0,0)];z=t.data.h[C];for(var F=0;F<z.c.length;F++){D.push(new THREE.Vector2(z.c[F][0],z.c[F][1]*t.verticalScale+0.1))}var E=new THREE.Shape(D);var B=-(x.width/b)/2;var A=-0.1;var y=-(x.height/b)/2+(C+1)*(x.height/b)/(t.data.h.length+1);t.addShape(E,B,A,y,0,0,0)}for(C=0;C<t.data.v.length;C++){D=[new THREE.Vector2(x.height/b,0),new THREE.Vector2(0,0)];z=t.data.v[C];for(var F=0;F<z.c.length;F++){D.push(new THREE.Vector2(z.c[F][0],z.c[F][1]*t.verticalScale+0.1))}var E=new THREE.Shape(D);var B=(x.height/b)/2;var A=-0.1;var y=(x.width/b)/2-(C+1)*(x.width/b)/(t.data.v.length+1);t.addShape(E,y,A,-B,0,-Math.PI/2,0)}};t.init=function(){c=m.width();i=m.height();l=c/2;k=i/2;p=new THREE.WebGLRenderer({antialias:true});p.setSize(c,i);p.physicallyBasedShading=true;p.shadowMapEnabled=true;p.shadowMapCullFace=THREE.CullFaceBack;m[0].appendChild(p.domElement);u=new THREE.PerspectiveCamera(50,c/i,1,1000);u.position.set(0,150,500);u.setLens(w);v=new THREE.Scene();dirLight1=new THREE.DirectionalLight(16777215,0.4);dirLight1.position.set(1,0,1);dirLight1.position.multiplyScalar(500);v.add(dirLight1);a=new THREE.DirectionalLight(16777215,1);a.position.set(-1,1,1);a.position.multiplyScalar(500);v.add(a);a.castShadow=true;a.shadowMapWidth=2048;a.shadowMapHeight=2048;var y=500;a.shadowCameraLeft=-y;a.shadowCameraRight=y;a.shadowCameraTop=y;a.shadowCameraBottom=-y;a.shadowCameraFar=3500;a.shadowBias=-0.0001;a.shadowDarkness=0.1;h=new THREE.Object3D();h.position.y=100;v.add(h);t.renderSlices();m[0].addEventListener("mousedown",t.onDocumentMouseDown,false);m[0].addEventListener("touchstart",t.onDocumentTouchStart,false);m[0].addEventListener("touchmove",t.onDocumentTouchMove,false);m[0].addEventListener("mousewheel",t.mousewheel,false);m[0].addEventListener("DOMMouseScroll",t.mousewheel,false);window.addEventListener("resize",t.onWindowResize,false)};t.onWindowResize=function(){c=m.width();i=m.height();l=c/2;k=i/2;u.aspect=c/i;u.updateProjectionMatrix();p.setSize(c,i)};t.onDocumentMouseDown=function(y){y.preventDefault();m[0].addEventListener("mousemove",t.onDocumentMouseMove,false);m[0].addEventListener("mouseup",t.onDocumentMouseUp,false);m[0].addEventListener("mouseout",t.onDocumentMouseOut,false);g=y.clientX-l;j=r;n=y.clientY-k;o=q};t.onDocumentMouseMove=function(y){f=y.clientX-l;e=y.clientY-k;r=j+(f-g)*0.02;q=o+(e-n)*0.02};t.onDocumentMouseUp=function(y){m[0].removeEventListener("mousemove",t.onDocumentMouseMove,false);m[0].removeEventListener("mouseup",t.onDocumentMouseUp,false);m[0].removeEventListener("mouseout",t.onDocumentMouseOut,false)};t.onDocumentMouseOut=function(y){m[0].removeEventListener("mousemove",t.onDocumentMouseMove,false);m[0].removeEventListener("mouseup",t.onDocumentMouseUp,false);m[0].removeEventListener("mouseout",t.onDocumentMouseOut,false)};t.onDocumentTouchStart=function(y){if(y.touches.length==1){y.preventDefault();g=y.touches[0].pageX-l;j=r;n=y.touches[0].pageY-k;o=q}};t.onDocumentTouchMove=function(y){if(y.touches.length==1){y.preventDefault();f=y.touches[0].pageX-l;r=j+(f-g)*0.05;e=y.touches[0].pageY-k;q=o+(e-n)*0.05}};t.mousewheel=function(y){y.preventDefault();y.stopPropagation();var z=0;if(y.wheelDelta){z=y.wheelDelta/40}else{if(y.detail){z=-y.detail/3}}w+=(1/z)*5;if(w<1){w=1}u.setLens(w)};t.animate=function(){requestAnimationFrame(t.animate);t.render()};t.render=function(){h.rotation.y+=(r-h.rotation.y)*0.05;h.rotation.x+=(q-h.rotation.x)*0.05;if(h.rotation.x<-Math.PI/4){h.rotation.x=-Math.PI/4}if(h.rotation.x>Math.PI/2){h.rotation.x=Math.PI/2}p.render(v,u)};t.init();t.animate();return t}Georigami.initIndex=function(){};var map;var elevator;var infowindow;draggableRectangle=function(b,f,i,c,l,m){var k={lat:f,lng:i,width:c,height:l};var a=new google.maps.LatLng(f,i);var e=true;var h=function(){};if(m.onChange!==null){h=m.onChange}k.getBounds=function(q){if(q==null){q=false}var r=google.maps.geometry.spherical.computeOffset(a,k.width/2,90);var p=google.maps.geometry.spherical.computeOffset(a,k.height/2,180);var t=google.maps.geometry.spherical.computeOffset(a,k.height/2,0);var o=google.maps.geometry.spherical.computeOffset(a,k.width/2,-90);if(q){return o.lng()+","+p.lat()+","+r.lng()+","+t.lat()}else{return new google.maps.LatLngBounds(new google.maps.LatLng(t.lat(),o.lng()),new google.maps.LatLng(p.lat(),r.lng()))}};k.updateCenter=function(o,n){e=false;a=new google.maps.LatLng(o,n);k.lat=o;k.lng=n;k.bounds=k.getBounds();j.setOptions({bounds:k.bounds});d.setPosition(a)};k.updateDimensions=function(o,n){e=false;k.width=o;k.height=n;k.bounds=k.getBounds();j.setOptions({bounds:k.bounds})};if(m==null){m={}}if(m.strokeColor==null){m.strokeColor="#000000"}if(m.strokeOpacity==null){m.strokeOpacity=0}if(m.strokeWeight==null){m.strokeWeight=2}if(m.fillColor==null){m.fillColor="#000000"}if(m.fillOpacity==null){m.fillOpacity=0}m.editable=true;k.bounds=k.getBounds();m.bounds=k.bounds;var j=new google.maps.Rectangle(m);j.setMap(b);var g=new google.maps.MarkerImage(Georigami.baseurl+"/img/hang.png",null,null,new google.maps.Point(8,8));var d=new google.maps.Marker({map:b,position:a,draggable:true,icon:g,raiseOnDrag:false,zIndex:10002});d.setAnimation(null);google.maps.event.addListener(d,"drag",function(n){k.updateCenter(n.latLng.lat(),n.latLng.lng());h()});google.maps.event.addListener(j,"bounds_changed",function(){k.bounds=j.getBounds();a=k.bounds.getCenter();k.lat=a.lat();k.lng=a.lng();d.setPosition(a);if(e){var o=k.bounds.getNorthEast();var n=k.bounds.getSouthWest();k.height=Math.round(google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(o.lat(),k.lng),new google.maps.LatLng(n.lat(),k.lng)));k.width=Math.round(google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(k.lat,o.lng()),new google.maps.LatLng(k.lat,n.lng())));h()}else{e=true}});google.maps.event.addListener(b,"click",function(n){k.updateCenter(n.latLng.lat(),n.latLng.lng());h()});return k};function createMarker(c,f,d,e){var b={position:f,map:map};if(d!=null){b.icon=new google.maps.MarkerImage(d,new google.maps.Size(18,28),new google.maps.Point(0,0),new google.maps.Point(9,28))}if(e!=null){b.shadow=new google.maps.MarkerImage(e,new google.maps.Size(33,28),new google.maps.Point(0,0),new google.maps.Point(9,28))}var a=new google.maps.Marker(b);google.maps.event.addListener(a,"click",function(){if(infowindow){infowindow.close()}infowindow=new google.maps.InfoWindow({content:c});infowindow.open(map,a)});google.maps.event.addListener(a,"mouseover",function(){});a.setAnimation(google.maps.Animation.DROP);return a}function grid(c,l,m,d,p,r,j,f){if(f==null){f=0}f=parseFloat(f);var b={lat:l,lng:m,width:d,height:p,vSlices:r,hSlices:j,rotate:f};var o=[];var k=[];var n=null;var a=new google.maps.LatLng(l,m);b.NE=google.maps.geometry.spherical.computeOffset(google.maps.geometry.spherical.computeOffset(a,p/2,0+f),d/2,90+f);b.SE=google.maps.geometry.spherical.computeOffset(google.maps.geometry.spherical.computeOffset(a,p/2,180+f),d/2,90+f);b.NW=google.maps.geometry.spherical.computeOffset(google.maps.geometry.spherical.computeOffset(a,p/2,0+f),d/2,-90+f);b.SW=google.maps.geometry.spherical.computeOffset(google.maps.geometry.spherical.computeOffset(a,p/2,180+f),d/2,-90+f);n=new google.maps.Polygon({path:[b.NE,b.SE,b.SW,b.NW],strokeColor:"#000000",strokeOpacity:1,strokeWeight:0.25,fillColor:"#FFFFFF",geodesic:true,zIndex:10001});n.setMap(c);var h=parseInt(r);for(var g=1;g<=h;g++){var q=[google.maps.geometry.spherical.interpolate(b.NW,b.NE,g/(h+1)),google.maps.geometry.spherical.interpolate(b.SW,b.SE,g/(h+1))];var e=new google.maps.Polyline({path:q,strokeColor:"#FF0000",strokeOpacity:1,strokeWeight:1,geodesic:true,zIndex:10001});e.setMap(c);o.push(e);k.push({type:"vertical",index:g,path:q})}h=parseInt(j);for(var g=1;g<=h;g++){var q=[google.maps.geometry.spherical.interpolate(b.NW,b.SW,g/(h+1)),google.maps.geometry.spherical.interpolate(b.NE,b.SE,g/(h+1))];var e=new google.maps.Polyline({path:q,strokeColor:"#FF0000",strokeOpacity:1,strokeWeight:1,geodesic:true,zIndex:10001});e.setMap(c);o.push(e);k.push({type:"horizontal",index:g,path:q})}b.clear=function(){if(n!=null){n.setMap(null)}for(var s=o.length-1;s>=0;s--){o[s].setMap(null)}o.length=0};b.setOptions=function(s){for(var t=o.length-1;t>=0;t--){o[t].setOptions(s)}};b.getBounds=function(){return new google.maps.LatLngBounds(b.SW,b.NE)};b.getData=function(){return k};b.getArray=function(){res=[];h=parseInt(j);for(var s=0;s<=h;s++){pt1=google.maps.geometry.spherical.interpolate(b.NW,b.SW,s/(h+1));pt2=google.maps.geometry.spherical.interpolate(b.NE,b.SE,s/(h+1));var t=parseInt(r);for(var u=0;u<=t;u++){res.push(google.maps.geometry.spherical.interpolate(pt1,pt2,u/(t+1)))}}return res};return b}$(function(){Georigami.initBloc=function(e){var g=function(o,m){if(o===null){o=j()}if(m===null){m=h()}blocid=$("#blocinfo").data("id");var n="bloc"+blocid+"_"+$("#blocinfo").data("view")+"?vscale="+m+"&face="+o;if(Modernizr.history){history.replaceState(null,null,n)}$("input[name=face]").val(o);$("#facepicker a").each(function(){$(this).attr("href","?vscale="+m+"&face="+$(this).data("face"))});$("#bloc-menu a").each(function(){var p=$(this).data("action");if(p!==null){$(this).attr("href","bloc"+blocid+"_"+p+"?vscale="+m+"&face="+o)}});$("#blocinfo img.bloc-face").attr("src",Georigami.baseurl+"/svg/"+Math.floor(blocid/100)+"/bloc"+blocid+o+".svg")};var f=function(m){$("#blocinfo").data("face",m);g(m,null)};var j=function(){return $("#blocinfo").data("face")};var l=function(m){$("#blocinfo").data("vscale",m);g(null,m)};var h=function(){return $("#blocinfo").data("vscale")};if(e=="3d"){var i=load3D(Georigami.bloc,$(".div3Dview"),$(".vs-input").val());var a=function(m){if(m=="W"){i.setRotation(Math.PI/2)}if(m=="N"){i.setRotation(Math.PI)}if(m=="E"){i.setRotation(3*Math.PI/2)}if(m=="S"){i.setRotation(0)}if(m=="doabarrelroll"){i.setRotation(6*Math.PI/2)}};a(j());$("#facepicker a").each(function(){$(this).click(function(){var m=$(this).data("face");a(m);f(m);$("#facepicker a.active").removeClass("active");$(this).addClass("active");return false})});$(".vs-input").change(function(){var m=$(this).val();i.setVerticalScale(m);l(m);return false});$(".vs-update").hide()}if(e=="profil"){$(".vs-update").hide();var b=function(p,o,m){if(m===null){m={}}if(m.dx===null){m.dx=0}if(m.dy===null){m.dy=0}if(m.dscale===null){m.dscale=0}if(m.vscale===null){m.vscale=1}profilobj=m;profilobj.changeStyle=function(r){p.attr("class",r)};profilobj.setSlicesTransform=function(E,C,D){var w=p.find("g.gslice").length;var A;var z;var u;var r;var B;profilobj.dx=E;profilobj.dy=C;profilobj.dscale=D;for(var s=0;s<w;s++){var v=p.find("#slice"+s);var t=v.find("g.gscale");u=1-profilobj.dscale*(((w-1)-s)/w);A=(s-w/2)*profilobj.dx;z=(s-w/2)*profilobj.dy;v[0].setAttribute("transform","translate("+A+","+z+")");t[0].setAttribute("transform","scale("+u+")")}q()};profilobj.onDocumentMouseDown=function(r){r.preventDefault();p[0].addEventListener("mousemove",profilobj.onDocumentMouseMove,false);p[0].addEventListener("mouseup",profilobj.onDocumentMouseUp,false);mouseXOnMouseDown=r.clientX;mouseYOnMouseDown=r.clientY};profilobj.onDocumentMouseMove=function(r){mouseX=r.clientX;mouseY=r.clientY;profilobj.updateDxDy((mouseX-mouseXOnMouseDown)/3000,(mouseY-mouseYOnMouseDown)/3000)};profilobj.onDocumentMouseUp=function(r){p[0].removeEventListener("mousemove",profilobj.onDocumentMouseMove,false);p[0].removeEventListener("mouseup",profilobj.onDocumentMouseUp,false);p[0].removeEventListener("mouseout",profilobj.onDocumentMouseOut,false)};profilobj.onDocumentMouseOut=function(r){p[0].removeEventListener("mousemove",profilobj.onDocumentMouseMove,false);p[0].removeEventListener("mouseup",profilobj.onDocumentMouseUp,false);p[0].removeEventListener("mouseout",profilobj.onDocumentMouseOut,false)};profilobj.mousewheel=function(r){r.preventDefault();r.stopPropagation();var s=0;if(r.wheelDelta){s=r.wheelDelta/40}else{if(r.detail){s=-r.detail/3}}profilobj.updateDScale(s/100)};p[0].addEventListener("mousedown",profilobj.onDocumentMouseDown,false);p[0].addEventListener("mousewheel",profilobj.mousewheel,false);p[0].addEventListener("DOMMouseScroll",profilobj.mousewheel,false);var n=function(){var s=Georigami.svg_hscale*profilobj.vscale;for(var y=0,r=o.coords.length;y<r;y++){var u=p.find("#slice"+y);var x="";for(var t=0,v=o.coords[y].c.length;t<v;t++){var w=o.coords[y].c[t];x=x+((w[0]-o.dim/2)*Georigami.svg_hscale)+","+(-w[1]*s)+","}u.find("polyline")[0].setAttribute("points",x);u.find("polygon")[0].setAttribute("points",x+(o.dim/2)*Georigami.svg_hscale+","+(0)*s+","+(-(o.dim/2)*Georigami.svg_hscale)+","+((0)*s))}q()};var q=function(){var B={left:10000,right:-10000,top:10000,bottom:-10000};var y=Georigami.svg_hscale*profilobj.vscale;for(var t=0,w=o.coords.length;t<w;t++){var C=1-profilobj.dscale*(((w-1)-t)/w);var r=(t-w/2)*profilobj.dy+o.max*Georigami.svg_hscale;var x=(t-w/2)*profilobj.dy+o.max*Georigami.svg_hscale-o.coords[t].m*y*C;var v=(t-w/2)*profilobj.dx+o.dim/2*Georigami.svg_hscale-o.dim/2*Georigami.svg_hscale*C;var z=(t-w/2)*profilobj.dx+o.dim/2*Georigami.svg_hscale+o.dim/2*Georigami.svg_hscale*C;if(x<B.top){B.top=x}if(r>B.bottom){B.bottom=r}if(v<B.left){B.left=v}if(z>B.right){B.right=z}}var s=B.right-B.left;var A=B.bottom-B.top;B.left=B.left-s*0.05;B.right=B.right+s*0.05;B.top=B.top-A*0.05;B.bottom=B.bottom+A*0.05;var u=B.left+" "+B.top+" "+(B.right-B.left)+" "+(B.bottom-B.top);p[0].setAttribute("viewBox",u)};profilobj.updateVScale=function(r){profilobj.vscale=r;n()};profilobj.updateDxDy=function(s,r){$("#input-translateX").val($("#input-translateX").val()*1+s);$("#input-translateY").val($("#input-translateY").val()*1+r);$("#input-translateX").trigger("change");$("#input-translateY").trigger("change")};profilobj.updateDScale=function(r){$("#input-scale").val($("#input-scale").val()*1+r);$("#input-scale").trigger("change")};return profilobj};var c=b($("#svgprofil"),Georigami.profil,{vscale:$(".vs-input").val(),dx:$("#input-translateX").val(),dy:$("#input-translateY").val(),dscale:$("#input-scale").val()});$("#styleswicther").change(function(){c.changeStyle($(this).val());k()});$("#input-translateX").change(function(){d()});$("#input-translateY").change(function(){d()});$("#input-scale").change(function(){d()});$(".vs-input").change(function(){c.updateVScale($(this).val());k()});var d=function(){var n=parseFloat($("#input-translateX").val());var m=parseFloat($("#input-translateY").val());var o=parseFloat($("#input-scale").val());c.setSlicesTransform(n,m,o);k()};var k=function(){var r=$("#input-face").val();var o=$(".vs-input").val();var n=$("#input-translateX").val();var m=$("#input-translateY").val();var t=$("#input-scale").val();var q=$("#styleswicther").val();var s=$("#blocinfo").data("id");var p="bloc"+s+"_"+$("#blocinfo").data("view")+"?vscale="+o+"&face="+r+"&dx="+n+"&dy="+m+"&dscale="+t+"&style="+q;if(Modernizr.history){history.replaceState(null,null,p)}$("#facepicker a").each(function(){$(this).attr("href","?vscale="+o+"&face="+$(this).data("face")+"&dx="+n+"&dy="+m+"&dscale="+t+"&style="+q)});$("#bloc-menu a").each(function(){var u=$(this).data("action");if(u!==null){$(this).attr("href","bloc"+s+"_"+u+"?vscale="+o+"&face="+r)}});$("#profildownload").attr("href","bloc"+s+"_download?vscale="+o+"&face="+r+"&dx="+n+"&dy="+m+"&dscale="+t+"&style="+q)}}}});$(function(){Georigami.initLocation=function(){function k(n,l,i){var m=grid(n,l.lat,l.lng,l.width,l.height,l.vslices,l.hslices,l.rotate);google.maps.event.addListener(i,"mouseover",function(){m.setOptions({strokeColor:"#00FF00"})});google.maps.event.addListener(i,"mouseout",function(){m.setOptions({strokeColor:"#FF0000"})});return m}var j=new google.maps.LatLng(Georigami.location.lat,Georigami.location.lng);var c={center:j,zoom:1,mapTypeId:google.maps.MapTypeId.TERRAIN};map=new google.maps.Map(document.getElementById("map-canvas2"),c);var d=[];var a=new google.maps.LatLngBounds();a.extend(j);for(var g=0;g<Georigami.location.blocs.length;g++){var f=Georigami.location.blocs[g];var b=new google.maps.LatLng(f.lat,f.lng);a.extend(b);var h='<a href="'+Georigami.baseurl+"/bloc"+f.id+'">';h=h+'<img src="'+Georigami.baseurl+"/bloc"+f.id+'N.svg" title="North" width="100px">';h=h+'<img src="'+Georigami.baseurl+"/bloc"+f.id+'W.svg" title="West" width="100px">';h=h+'<img src="'+Georigami.baseurl+"/bloc"+f.id+'S.svg" title="South" width="100px">';h=h+'<img src="'+Georigami.baseurl+"/bloc"+f.id+'E.svg" title="Est" width="100px">';h=h+"<br/>";h=h+"altitude: "+Math.round(f.min)+"m to "+Math.round(f.max)+"m<br/>";h=h+f.width+"m x "+f.height+"m<br/>";h=h+"slices: "+f.vslices+" x "+f.hslices+"<br/>";h=h+(f.vslices*f.vsamples+f.hslices*f.hsamples)+" samples<br/>";h=h+"created at  "+f.created_at+"<br/>";h=h+"</a>";var e=createMarker(h,new google.maps.LatLng(f.lat,f.lng),Georigami.baseurl+"/img/ico/"+Georigami.location.icon+".png",Georigami.baseurl+"/img/ico/shadow.png");gridObj=k(map,f,e);a.union(gridObj.getBounds())}map.fitBounds(a)}});$(function(){Georigami.initMap=function(){var c={center:new google.maps.LatLng(0,0),zoom:2,mapTypeId:google.maps.MapTypeId.TERRAIN};map=new google.maps.Map(document.getElementById("map-canvas"),c);google.maps.event.addListener(map,"click",function(j){var i="lat: "+j.latLng.lat()+"<br/>lng: "+j.latLng.lng()+"<br/><br/>";i=i+'<a href="'+Georigami.baseurl+"/new?lat="+j.latLng.lat()+"&lng="+j.latLng.lng()+'" class="btn btn-primary btn-small"/>build a new on here</a>';if(infowindow){infowindow.close()}infowindow=new google.maps.InfoWindow({content:i,position:new google.maps.LatLng(j.latLng.lat(),j.latLng.lng())});infowindow.open(map)});google.maps.event.addListener(map,"zoom_changed",function(){if((map.zoom>15)&&(map.getMapTypeId()==google.maps.MapTypeId.TERRAIN)){map.setMapTypeId(google.maps.MapTypeId.ROADMAP)}if(map.zoom>19){map.setMapTypeId(google.maps.MapTypeId.ROADMAP)}if(map.zoom<=15){map.setMapTypeId(google.maps.MapTypeId.TERRAIN)}});var d=[];for(var h=0;h<Georigami.location_list.length;h++){var g=Georigami.location_list[h];var b=new google.maps.LatLng(g.lat,g.lng);var k='<a href="'+g.url+'"><h3 title="'+g.feature+'">'+g.name+'</h3><img src="'+Georigami.baseurl+"/img/flags/"+g.countrycode.toLowerCase()+'.png" title="'+g.countryname+'"/> '+g.countryname+" "+g.adminname1+"<br/>";for(var e=0;e<g.blocs.length;e++){var m=g.blocs[e];k=k+"<div>";k=k+'<img src="'+Georigami.baseurl+"/svg/"+Math.floor(m.id/100)+"/bloc"+m.id+'N.svg" title="North" width="64px">';k=k+"</div>";k=k+"</a>"}var f=createMarker(k,new google.maps.LatLng(g.lat,g.lng),Georigami.baseurl+"/img/ico/"+g.icon+".png",Georigami.baseurl+"/img/ico/shadow.png");d.push(f)}var l={gridSize:50,maxZoom:15};var a=new MarkerClusterer(map,d,l)}});$(function(){Georigami.status=null;var a=function(d,c){$("#status .text").html(d);if(c!==undefined){if(!$("#status .progress").length){$('<div class="progress progress-striped active"><div class="bar" style="width: '+(c*100)+'%;"></div></div>').appendTo($("#status"))}else{$("#status .progress .bar").css("width",(c*100)+"%")}}else{$("#status .progress").remove()}};Georigami.initNew=function(){var d=null;Georigami.setStatus=function(p){if(p=="ready"){$("#start-btn").removeClass("disabled");$("#cancel-btn").addClass("disabled")}else{$("#start-btn").addClass("disabled")}if(p=="loading"){$("#cancel-btn").removeClass("disabled")}Georigami.status=p};Georigami.setStatus(null);$("#input-search").change(function(){var p=$("#input-search").val();if(p===""){$("#search-result").html("");return false}$("#search-result").html('<i class="loading"></i> searching ...');$.ajax({url:Georigami.baseurl+"/search",type:"POST",data:{q:$("#input-search").val()},success:function(s){$("#search-result").html("");if(s.geonames.length>0){$("#search-result").html("<ul></ul>")}else{$("#search-result").html('<div class="alert alert-error">no results for '+$("#input-search").val()+"</div>")}for(var r=0;r<s.geonames.length;r++){var q='<li><a href="#" data-lat="'+s.geonames[r].lat+'" data-lng="'+s.geonames[r].lng+'">';if(s.geonames[r].country!==""){q=q+'<img src="'+Georigami.baseurl+"/img/flags/"+s.geonames[r].countryCode.toLowerCase()+'.png" title="'+s.geonames[r].country+'"/> '}q=q+s.geonames[r].name;if(s.geonames[r].feature!==""){q=q+" ("+s.geonames[r].feature[0]+")"}q=q+"</a></li>";$(q).appendTo($("#search-result>ul"))}$("#search-result a").on("click",function(){$("#input-latitude").val($(this).data("lat"));$("#input-longitude").val($(this).data("lng"));Georigami.update();return false})}});return false});var n=[];var k=[];var l=null;var i=5000;Georigami.results=[];var e={center:new google.maps.LatLng(Georigami.area.lat,Georigami.area.lng),zoom:2,mapTypeId:google.maps.MapTypeId.TERRAIN};var c=new google.maps.Map(document.getElementById("map-canvas"),e);var f=function(){$("#input-latitude").val(Georigami.rectangle.lat);$("#input-longitude").val(Georigami.rectangle.lng);$("#input-width").val(Georigami.rectangle.width);$("#input-height").val(Georigami.rectangle.height);h(o())};var o=function(){var p={};p.lat=parseFloat($("#input-latitude").val());p.lng=parseFloat($("#input-longitude").val());p.width=parseFloat($("#input-width").val());p.height=parseFloat($("#input-height").val());p.vSlices=parseFloat($("#input-vertical-slices").val());p.hSlices=parseFloat($("#input-horizontal-slices").val());p.vSampling=parseFloat($("#input-vsampling").val());p.hSampling=parseFloat($("#input-hsampling").val());p.rotate=parseFloat($("#input-rotate").val());p.vSamples=p.vSampling*(p.hSlices+1)+1;$("#input-vertical-samples").val(p.vSamples);p.hSamples=p.hSampling*(p.vSlices+1)+1;$("#input-horizontal-samples").val(p.hSamples);p.bbox=Georigami.rectangle.getBounds(true);if((Georigami.rectangle.lat!==0)||(Georigami.rectangle.lng!==0)){if(Georigami.status!="loading"){Georigami.setStatus("ready")}}return p};var g=function(p){$("#input-latitude").val(p.lat);$("#input-longitude").val(p.lng);$("#input-width").val(p.width);$("#input-height").val(p.height);$("#input-vertical-slices").val(p.vSlices);$("#input-horizontal-slices").val(p.hSlices);$("#input-hsampling").val(p.hsampling);$("#input-vsampling").val(p.vsampling);$("#input-rotate").val(p.rotate);$("input").trigger("change")};var h=function(p){if(d!==null){d.clear()}d=grid(c,p.lat,p.lng,p.width,p.height,p.vSlices,p.hSlices,p.rotate)};Georigami.update=function(){Georigami.rectangle.updateCenter($("#input-latitude").val(),$("#input-longitude").val());Georigami.rectangle.updateDimensions($("#input-width").val(),$("#input-height").val());h(o());c.fitBounds(Georigami.rectangle.getBounds())};g(Georigami.area);Georigami.rectangle=draggableRectangle(c,Georigami.area.lat,Georigami.area.lng,Georigami.area.width,Georigami.area.height,{onChange:f});f();if((Georigami.area.lat!==0)||(Georigami.area.lng!==0)){Georigami.update()}$(".livechange").keypress(function(){setTimeout("Georigami.update()",1)});$(".livechange").mouseup(function(){Georigami.update()});$(".livechange").change(function(){Georigami.update()});$("#update-btn").mousedown(function(){Georigami.update();return false});$("#paramform").submit(function(){return false});var m=function(C){var t=C.params;t.vSlicesObj=[];t.hSlicesObj=[];t.min=Infinity;t.max=-Infinity;var A,w,v;var q=Math.max(t.width,t.height);for(var u=0;u<C.slices.length;u++){for(var p=0;p<C.slices[u].data.length;p++){v=C.slices[u].data[p].elevation;if(v<t.min){t.min=v}if(v>t.max){t.max=v}}}for(u=0;u<C.slices.length;u++){var B=C.slices[u];var r=[];for(var p=0;p<B.data.length;p++){v=B.data[p].elevation;if(B.type=="vertical"){A=p/(B.data.length-1)*t.height/q}else{A=p/(B.data.length-1)*t.width/q}w=(v-t.min)/q;r.push([A,w])}if(B.type=="vertical"){t.vSlicesObj.push(r)}else{t.hSlicesObj.push(r)}}t.vSlicesObj=t.vSlicesObj.reverse();return t};Georigami.loadSlice=function(p,r){var w=p.slices[r];var v="";var q;a("loading slice "+(r+1)+"/"+p.slices.length,(r+1)/p.slices.length);var u=[];$.each(w.path,function(x,y){if(v!==""){v=v+"|"}v=v+y.lat()+","+y.lng();u.push(new google.maps.LatLng(y.lat(),y.lng()))});if(w.type=="vertical"){q=p.params.vSamples}else{q=p.params.hSamples}var s={path:u,samples:q};if(Georigami.status!="cancel"){elevator=new google.maps.ElevationService();elevator.getElevationAlongPath(s,t)}else{a("");Georigami.setStatus("ready")}function t(y,x){if(x!="OK"){Georigami.alert("GOOGLE ELEVATION API ERROR",x);a("");Georigami.setStatus("ready");return}w.data=y;if(r+1<p.slices.length){setTimeout(function(){Georigami.loadSlice(p,r+1)},i*(q/500))}else{post=m(p);post.coords=JSON.stringify({v:post.vSlicesObj,h:post.hSlicesObj});delete post.vSlicesObj;delete post.hSlicesObj;a("show result");$.ajax({url:Georigami.baseurl+"/new",type:"POST",data:post,success:function(z){var A=b(Georigami.results.length+1,z,$("#resultats"));Georigami.results.push({data:z});a("")}})}}};$("#start-btn").click(function(){if(Georigami.status=="ready"){var p={params:o(),slices:d.getData()};j(p);Georigami.setStatus("loading")}else{if(Georigami.status=="loading"){Georigami.alert("Please wait","Work in progress")}else{Georigami.alert("but where ?","Please select an area")}}return false});$("#cancel-btn").click(function(){if(Georigami.status=="loading"){Georigami.setStatus("cancel")}});var j=function(p){$(".div3Dview").hide();Georigami.setStatus("loading");Georigami.loadSlice(p,0)}};var b=function(g,e,f){Georigami.setStatus("ready");var d='<div class="result"><p class="index">result '+g+'</p><a href="'+e.location.url+'"><img src="'+Georigami.baseurl+"/img/flags/"+e.location.countrycode.toLowerCase()+'.png" title="'+e.location.countryname+'"/> '+e.location.countryname+"<br/>"+e.location.name+'</a></td></tr><div class="row"><a href="'+e.url+'"><img src="'+Georigami.baseurl+"/svg/"+Math.floor(e.id/100)+"/bloc"+e.id+'N.svg" class="span2"/><img src="'+Georigami.baseurl+"/svg/"+Math.floor(e.id/100)+"/bloc"+e.id+'E.svg" class="span2"/><img src="'+Georigami.baseurl+"/svg/"+Math.floor(e.id/100)+"/bloc"+e.id+'S.svg" class="span2"/><img src="'+Georigami.baseurl+"/svg/"+Math.floor(e.id/100)+"/bloc"+e.id+'W.svg" class="span2"/><div class="span2">altitude: '+Math.round(e.min)+"m to "+Math.round(e.max)+"m<br/>"+e.width+"m x "+e.height+"m<br/>rotation: "+e.rotate+"m<br/>slices: "+e.hslices+" x "+e.vslices+"<br/>"+(e.vslices*e.vsamples+e.hslices*e.hsamples)+" samples<br/>"+e.created_at+"</div></a></div></div>";var c=$(d).prependTo(f)}});$(function(){defaultParam=function(b,a){return(typeof b==="undefined")?a:b};Georigami.alert=function(b,a){a='<div id="myModal" class="modal hide fade alert-error" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button><h3 id="myModalLabel">'+b+'</h3></div><div class="modal-body">'+a+'</div><div class="modal-footer"><button class="btn" data-dismiss="modal" aria-hidden="true">Close</button></div></div>';$(a).modal("show")};$('input[type="number"]').each(function(a,c){if(c.type!="number"){var b=$(this);b.spinner();b.on("spin",function(d,e){setTimeout(function(){b.trigger("change")},1)})}});$('input[type="range"]').each(function(c,g){var f=$(this);if(g.type=="range"){var e=g.step;if(null===e){e=1}var b=$('<input type="number" value="'+f.val()+'" min="'+g.min+'" max="'+g.max+'" step="'+e+'" class="'+f.attr("class")+'"></div>').insertAfter(f);$("<br/>").insertAfter(f);f.removeClass().change(function(){b.val(f.val())});b.change(function(){f.val(b.val());f.trigger("change")});b.keypress(function(){setTimeout(function(){f.val(b.val())},1)})}else{g.type="number";var a=$('<div class="slider"></div>').insertBefore(f);var e=g.step;if(e==null){e=1}e=parseFloat(e);var d=a.slider({value:parseFloat(f.val()),min:parseFloat(g.min),max:parseFloat(g.max),step:e,slide:function(h,i){f.val(i.value);f.trigger("change")}});f.change(function(){a.slider("option","value",f.val())});f.keypress(function(){setTimeout(function(){a.slider("option","value",f.val())},1)})}});if(typeof Georigami=="undefined"){Georigami={}}if($("body").hasClass("bloc3d")){Georigami.initBloc("3d")}if($("body").hasClass("print")){Georigami.initBloc("print")}if($("body").hasClass("profil")){Georigami.initBloc("profil")}if($("body").hasClass("location")){Georigami.initLocation()}if($("body").hasClass("map")){Georigami.initMap()}if($("body").hasClass("new")){Georigami.initNew()}setTimeout(function(){$("body.savedindex img.profil").width(function(){return $(this).width()-1})},500);setTimeout(function(){$("body.savedindex img.profil").width(function(){return $(this).width()+1})},510)});